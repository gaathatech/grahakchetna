{% extends "base.html" %}

{% block title %}Nexora Media Manager{% endblock %}

{% block content %}
<style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        html, body {
            width: 100%;
            height: 100%;
            overflow-x: hidden;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            background-attachment: fixed;
            color: #fff;
            padding: 12px 8px;
            min-height: 100vh;
            font-size: clamp(14px, 3vw, 16px);
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr;
            gap: clamp(15px, 5vw, 30px);
            position: relative;
            padding: 0;
        }
        
        .section {
            background: rgba(20, 20, 20, 0.9);
            border: 1px solid rgba(30, 144, 255, 0.12);
            border-radius: 8px;
            padding: clamp(12px, 4vw, 30px);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        h1 {
            grid-column: 1 / -1;
            text-align: center;
            font-size: clamp(1.5em, 6vw, 2.5em);
            margin-bottom: 8px;
            background: linear-gradient(135deg, #66b2ff, #0066ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            word-break: break-word;
        }
        
        .subtitle {
            grid-column: 1 / -1;
            text-align: center;
            color: #aaa;
            margin-bottom: clamp(15px, 4vw, 30px);
            font-size: 0.85em;
            word-break: break-word;
        }
        
        h2 {
            color: #66b2ff;
            margin-bottom: clamp(12px, 3vw, 20px);
            font-size: clamp(1.1em, 4vw, 1.5em);
            text-transform: uppercase;
            letter-spacing: 1px;
            word-break: break-word;
        }
        
        label {
            display: block;
            margin-bottom: 6px;
            color: #ccc;
            font-weight: 600;
            font-size: 0.9em;
            word-break: break-word;
        }
        
        input, textarea, select {
            width: 100%;
            padding: clamp(10px, 3vw, 12px);
            margin: 0 0 clamp(12px, 3vw, 20px) 0;
            border-radius: 5px;
            border: 1px solid rgba(70, 130, 180, 0.15);
            background: rgba(40, 40, 40, 0.8);
            color: #fff;
            font-family: inherit;
            font-size: 16px;
            -webkit-appearance: none;
            appearance: none;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #66b2ff;
            box-shadow: 0 0 10px rgba(102, 178, 255, 0.25);
        }
        
        textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        button {
            min-height: 44px;
            padding: clamp(10px, 3vw, 12px) clamp(15px, 4vw, 30px);
            background: linear-gradient(135deg, #66b2ff, #0066ff);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            font-size: clamp(0.9em, 2.5vw, 1em);
            transition: all 0.3s ease;
            width: 100%;
            text-transform: uppercase;
            letter-spacing: 1px;
            -webkit-appearance: none;
            appearance: none;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 178, 255, 0.28);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .status {
            padding: clamp(10px, 3vw, 15px);
            border-radius: 5px;
            margin-top: 15px;
            display: none;
            font-size: 0.9em;
            word-break: break-word;
        }
        
        .status.show {
            display: block;
        }
        
        .status.success {
            background: rgba(0, 128, 0, 0.2);
            border: 1px solid rgba(0, 200, 0, 0.5);
            color: #90EE90;
        }
        
        .status.error {
            background: rgba(30, 144, 255, 0.08);
            border: 1px solid rgba(30, 144, 255, 0.18);
            color: #66b2ff;
        }
        
        .status.loading {
            background: rgba(100, 150, 255, 0.2);
            border: 1px solid rgba(100, 149, 237, 0.5);
            color: #87CEEB;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .spinner {
            display: inline-flex;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: #87CEEB;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            flex-shrink: 0;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(min(100%, 250px), 1fr));
            gap: clamp(10px, 2vw, 20px);
        }
        
        .video-card {
            background: rgba(30, 30, 30, 0.8);
            border: 1px solid rgba(30, 144, 255, 0.12);
            border-radius: 6px;
            padding: clamp(10px, 3vw, 15px);
            transition: all 0.3s ease;
            position: relative;
        }
        
        .video-card:hover {
            border-color: #66b2ff;
            box-shadow: 0 0 15px rgba(102, 178, 255, 0.16);
        }
        
        .video-title {
            color: #66b2ff;
            font-weight: 600;
            margin-bottom: 6px;
            word-break: break-word;
            font-size: 0.9em;
        }
        
        .video-meta {
            font-size: 0.8em;
            color: #aaa;
            margin-bottom: 8px;
        }
        
        .video-meta-item {
            margin: 3px 0;
            word-break: break-word;
        }
        
        .video-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 10px;
        }
        
        .video-actions button {
            flex: 1;
            min-width: 60px;
            padding: 6px 8px;
            font-size: 0.75em;
            margin: 0;
            min-height: 36px;
        }
        
        .video-actions .delete-btn {
            background: linear-gradient(135deg, #0044aa, #002244);
        }
        .video-actions .share-fb {
            background: linear-gradient(135deg, #1877f2, #0052cc);
        }
        .video-actions .share-ig {
            background: linear-gradient(135deg, #7a4fe3, #ff7a59);
        }
        .video-actions .share-wp {
            background: linear-gradient(135deg, #21759b, #0b6a83);
        }
        
        .video-actions .download-btn {
            background: linear-gradient(135deg, #00aa00, #006600);
        }
        
        .empty-message {
            text-align: center;
            color: #666;
            padding: 40px 20px;
            font-size: 1.1em;
        }
        
        .language-badge {
            display: inline-block;
            background: rgba(30, 144, 255, 0.6);
            color: #fff;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.7em;
            margin-top: 6px;
        }
        .post-info {
            margin-top: 10px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 6px;
            font-size: 0.85em;
            color: #cfeefe;
            word-break: break-word;
        }
        .post-info a {
            color: #bfe4ff;
            text-decoration: underline;
        }
        .post-actions {
            margin-top: 6px;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        
        .size-badge {
            display: inline-block;
            background: rgba(100, 100, 100, 0.5);
            color: #fff;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.7em;
            margin-left: 5px;
        }

        /* Tabs/Navigation Styles - MOBILE OPTIMIZED */
        .tabs-nav {
            display: flex;
            gap: 2px;
            margin-bottom: 15px;
            border-bottom: 2px solid rgba(102, 178, 255, 0.2);
            overflow-x: auto;
            padding-bottom: 0;
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
        }
        
        .tabs-nav::-webkit-scrollbar {
            height: 3px;
        }
        
        .tabs-nav::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .tabs-nav::-webkit-scrollbar-thumb {
            background: rgba(102, 178, 255, 0.3);
            border-radius: 2px;
        }

        .tab-btn {
            padding: clamp(8px, 2vw, 12px) clamp(10px, 2vw, 20px);
            background: transparent;
            color: #888;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 600;
            font-size: clamp(0.75em, 2vw, 0.95em);
            white-space: nowrap;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            min-height: 44px;
            display: flex;
            align-items: center;
        }

        .tab-btn:hover {
            color: #66b2ff;
        }

        .tab-btn.active {
            color: #66b2ff;
            border-bottom-color: #66b2ff;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .file-upload-group {
            border: 2px dashed rgba(102, 178, 255, 0.3);
            border-radius: 8px;
            padding: clamp(12px, 3vw, 20px);
            text-align: center;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .file-upload-group:hover {
            border-color: #66b2ff;
            background: rgba(102, 178, 255, 0.05);
        }

        .file-upload-group:active {
            border-color: #66b2ff;
            background: rgba(102, 178, 255, 0.1);
        }

        .file-upload-group input[type="file"] {
            display: none;
        }

        .upload-text {
            color: #888;
            font-size: 0.85em;
            margin: 6px 0;
            word-break: break-word;
        }

        .file-name {
            color: #66b2ff;
            font-size: 0.9em;
            margin-top: 6px;
            word-break: break-word;
        }

        /* ===== MOBILE & TABLET OPTIMIZATIONS ===== */
        @media (max-width: 1024px) {
            .container {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 8px 6px;
            }
            
            .container {
                gap: clamp(10px, 3vw, 25px);
            }
            
            .section {
                padding: clamp(10px, 3vw, 20px);
                border-radius: 6px;
            }
            
            h1 {
                font-size: clamp(1.3em, 5vw, 2em);
                margin-bottom: 6px;
            }
            
            h2 {
                font-size: clamp(1em, 3.5vw, 1.3em);
                margin-bottom: clamp(10px, 2vw, 15px);
            }
            
            .tabs-nav {
                gap: 1px;
                margin-bottom: 12px;
            }
            
            .tab-btn {
                padding: clamp(6px, 1.5vw, 10px) clamp(8px, 1.5vw, 15px);
                font-size: clamp(0.7em, 1.8vw, 0.85em);
                letter-spacing: 0;
                min-height: 40px;
            }
            
            input, textarea, select {
                font-size: 16px;
                padding: clamp(8px, 2.5vw, 12px);
                margin-bottom: clamp(10px, 2.5vw, 15px);
            }
            
            button {
                min-height: 40px;
                padding: clamp(8px, 2.5vw, 10px) clamp(12px, 3vw, 20px);
                font-size: clamp(0.85em, 2vw, 0.95em);
            }
            
            .video-grid {
                grid-template-columns: repeat(auto-fill, minmax(min(100%, 200px), 1fr));
                gap: clamp(8px, 2vw, 15px);
            }
            
            .video-card {
                padding: clamp(8px, 2.5vw, 12px);
            }
            
            .video-actions {
                gap: 4px;
            }
            
            .video-actions button {
                min-height: 32px;
                font-size: 0.7em;
                padding: 4px 6px;
            }
            
            label {
                margin-bottom: 4px;
                font-size: 0.85em;
            }
            
            .file-upload-group {
                padding: clamp(10px, 2.5vw, 15px);
                min-height: 70px;
            }
            
            .upload-text {
                font-size: 0.8em;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 6px 4px;
            }
            
            .container {
                gap: clamp(8px, 2vw, 15px);
            }
            
            .section {
                padding: clamp(8px, 2vw, 15px);
                border-radius: 5px;
                border: 1px solid rgba(30, 144, 255, 0.1);
            }
            
            h1 {
                font-size: clamp(1.1em, 4vw, 1.6em);
                margin-bottom: 4px;
            }
            
            .subtitle {
                margin-bottom: clamp(10px, 2vw, 20px);
                font-size: 0.8em;
            }
            
            h2 {
                font-size: clamp(0.95em, 2.5vw, 1.1em);
                margin-bottom: clamp(8px, 2vw, 12px);
                letter-spacing: 0;
            }
            
            label {
                font-size: 0.8em;
                margin-bottom: 3px;
            }
            
            .tabs-nav {
                gap: 0;
                margin-bottom: 10px;
                border-bottom: 1px solid rgba(102, 178, 255, 0.1);
                padding: 0;
            }
            
            .tab-btn {
                padding: clamp(5px, 1.2vw, 8px) clamp(6px, 1vw, 10px);
                font-size: clamp(0.65em, 1.5vw, 0.75em);
                min-height: 36px;
                margin: 0;
                border-right: 1px solid rgba(102, 178, 255, 0.1);
            }
            
            .tab-btn:last-child {
                border-right: none;
            }
            
            input, textarea, select {
                font-size: 16px;
                padding: clamp(7px, 2vw, 10px);
                margin-bottom: clamp(8px, 2vw, 12px);
                border-radius: 4px;
            }
            
            textarea {
                min-height: 60px;
            }
            
            button {
                min-height: 36px;
                padding: clamp(6px, 1.5vw, 8px) clamp(10px, 2vw, 15px);
                font-size: clamp(0.8em, 1.8vw, 0.85em);
                border-radius: 4px;
                letter-spacing: 0;
            }
            
            .status {
                padding: clamp(8px, 2vw, 12px);
                margin-top: 8px;
                font-size: 0.8em;
            }
            
            .video-grid {
                grid-template-columns: repeat(auto-fill, minmax(min(100%, 140px), 1fr));
                gap: clamp(6px, 1.5vw, 10px);
            }
            
            .video-card {
                padding: clamp(6px, 1.5vw, 10px);
                border-radius: 4px;
            }
            
            .video-title {
                font-size: 0.8em;
                margin-bottom: 4px;
            }
            
            .video-meta {
                font-size: 0.7em;
                margin-bottom: 6px;
            }
            
            .video-actions {
                gap: 2px;
                margin-top: 6px;
            }
            
            .video-actions button {
                min-height: 28px;
                font-size: 0.65em;
                padding: 2px 4px;
                min-width: 40px;
            }
            
            .file-upload-group {
                padding: clamp(8px, 2vw, 12px);
                min-height: 60px;
                margin: 8px 0;
            }
            
            .upload-text {
                font-size: 0.75em;
                margin: 4px 0;
            }
            
            .file-name {
                font-size: 0.8em;
                margin-top: 4px;
            }
            
            .language-badge {
                font-size: 0.65em;
                padding: 1px 4px;
            }
            
            .post-info {
                font-size: 0.75em;
                padding: 6px;
                margin-top: 8px;
            }

            /* Hide text on smaller buttons, show emoji/icons only */
            .tab-btn span:nth-of-type(2) {
                display: none;
            }
        }

        @media (max-width: 360px) {
            .section {
                padding: 8px;
            }
            
            h1 {
                font-size: 1em;
            }
            
            h2 {
                font-size: 0.9em;
                margin-bottom: 8px;
            }
            
            .tab-btn {
                font-size: 0.6em;
                padding: 4px 6px;
                min-height: 32px;
            }
            
            input, textarea, select {
                font-size: 16px;
                padding: 6px;
            }
            
            button {
                min-height: 32px;
                font-size: 0.75em;
                padding: 6px 8px;
            }
        }

        /* Landscape orientation fixes */
        @media (max-height: 500px) {
            .section {
                padding: clamp(8px, 2vw, 12px);
            }
            
            h2 {
                margin-bottom: 8px;
            }
            
            input, textarea {
                margin-bottom: 8px;
            }
            
            textarea {
                min-height: 50px;
            }
            
            button {
                min-height: 36px;
            }
        }
    </style>

    <script>
        // initial tab to open when index rendered via route
        var initialTab = "{{ open_tab|default('create-short') }}";
    </script>

    <div id="sslWarning" style="display:none; background:#ff4444; color:#fff; padding:10px; border-radius:6px; margin:8px 0; font-weight:700;">Warning: WordPress SSL verification is disabled ‚Äî connections are insecure.</div>

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div style="grid-column: 1 / -1; margin-bottom: 12px;">
        {% for category, msg in messages %}
            <div class="status show {{ 'success' if category == 'success' else 'error' }}">{{ msg }}</div>
        {% endfor %}
    </div>
    {% endif %}
    {% endwith %}

    <div style="grid-column: 1 / -1; margin-bottom: 12px;">
        <a href="/rss"><button type="button">Open RSS Manager</button></a>
    </div>

    <div class="container">
        <!-- CREDENTIAL STATUS BADGE -->
        <div style="grid-column: 1 / -1; background: rgba(20, 40, 60, 0.9); border: 1px solid rgba(30, 144, 255, 0.2); border-radius: 8px; padding: 12px 16px; display: flex; flex-wrap: wrap; gap: 12px; align-items: center; margin-bottom: 10px;">
            <span style="color: #888; font-size: 0.85em; min-width: 100%;">Platform Status:</span>
            <div id="fb-status-badge" style="display: flex; align-items: center; gap: 6px; font-size: 0.85em;">
                <span style="width: 8px; height: 8px; border-radius: 50%; background: #888;"></span>
                <span>Facebook</span>
            </div>
            <div id="ig-status-badge" style="display: flex; align-items: center; gap: 6px; font-size: 0.85em;">
                <span style="width: 8px; height: 8px; border-radius: 50%; background: #888;"></span>
                <span>Instagram</span>
            </div>
            <div id="wp-status-badge" style="display: flex; align-items: center; gap: 6px; font-size: 0.85em;">
                <span style="width: 8px; height: 8px; border-radius: 50%; background: #888;"></span>
                <span>WordPress</span>
            </div>
        </div>
        <!-- NAVIGATION TABS -->
        <div class="tabs-nav" style="grid-column: 1 / -1;">
            <button class="tab-btn active" data-tab="create-short" onclick="switchTab('create-short')">‚è± Short Video</button>
            <button class="tab-btn" data-tab="create-long" onclick="switchTab('create-long')">‚ñ∂ Long Video</button>
            <button class="tab-btn" data-tab="wp-post" onclick="switchTab('wp-post')">üìù WordPress</button>
            <button class="tab-btn" data-tab="fb-post" onclick="switchTab('fb-post')">üë§ Facebook</button>
            <button class="tab-btn" data-tab="ig-post" onclick="switchTab('ig-post')">üì∏ Instagram</button>
            <button class="tab-btn" data-tab="videos" onclick="switchTab('videos')">üìπ Videos</button>
        </div>

        <!-- ============= TAB 1: CREATE SHORT VIDEO ============= -->
        <div id="create-short" class="tab-content active section">
            <h2>‚è± Create Short Video (15 seconds)</h2>
            <form id="generateForm" method="POST" action="/generate">
                <label for="headline">Headline</label>
                <input type="text" id="headline" name="headline" placeholder="Breaking News: Major Development..." required>

                <label for="description">Description</label>
                <textarea id="description" name="description" placeholder="Provide detailed description of the news story..." required></textarea>

                <label for="language">Language</label>
                <select id="language" name="language" required>
                    <option value="english">üá¨üáß English</option>
                    <option value="hindi">üáÆüá≥ Hindi</option>
                    <option value="gujarati">üáÆüá≥ Gujarati</option>
                </select>

                <input type="hidden" id="video_length" name="video_length" value="short">

                <label for="voice_provider">Voice Provider</label>
                <select id="voice_provider" name="voice_provider">
                    <option value="auto">Auto (recommended)</option>
                    <option value="edge">Edge TTS</option>
                    <option value="eleven">ElevenLabs</option>
                    <option value="gtts">gTTS</option>
                </select>

                <label for="voice_model">Voice Model</label>
                <select id="voice_model" name="voice_model">
                    <option value="auto">Auto</option>
                </select>

                <button type="submit" id="submitBtn">Generate Video</button>
                
                <div id="status" class="status"></div>
            </form>
        </div>

        <!-- ============= TAB 2: CREATE LONG VIDEO ============= -->
        <div id="create-long" class="tab-content section">
            <h2>‚ñ∂ Create Long Video (Full Duration)</h2>
            <form id="generateFormLong" method="POST" action="/generate-long" enctype="multipart/form-data">
                <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-bottom:10px;">
                    <label style="margin:0">Language</label>
                    <select id="language2" name="language" required style="max-width:220px;">
                        <option value="english">üá¨üáß English</option>
                        <option value="hindi">üáÆüá≥ Hindi</option>
                        <option value="gujarati">üáÆüá≥ Gujarati</option>
                    </select>

                    <label style="margin:0">Voice Provider</label>
                    <select id="voice_provider2" name="voice_provider" style="max-width:220px;">
                        <option value="auto">Auto (recommended)</option>
                        <option value="edge">Edge TTS</option>
                        <option value="eleven">ElevenLabs</option>
                        <option value="gtts">gTTS</option>
                    </select>
                </div>

                <input type="hidden" id="video_length2" name="video_length" value="full">

                <h3 style="margin-top:6px">Stories (add one or more)</h3>
                <div id="storiesContainer">
                    <!-- Template story block inserted by JS -->
                </div>

                <div style="display:flex;gap:8px;margin-bottom:12px;">
                    <button type="button" id="addStoryBtn">+ Add Story</button>
                    <button type="button" id="clearStoriesBtn">Clear Stories</button>
                </div>

                <small style="display:block;color:#aaa;margin-bottom:10px">Each story may include an optional image/video upload (used as green screen/visual). If none provided, the system will attempt to fetch a suitable image.</small>

                <button type="submit" id="submitBtnLong">Generate Video</button>
                
                <div id="statusLong" class="status"></div>
            </form>
        </div>

        <!-- ============= TAB 3: WORDPRESS POSTING ============= -->
        <div id="wp-post" class="tab-content section">
            <h2>üìù WordPress Posting</h2>
            <form id="wpPostForm">
                <label for="wpFileUpload">Select Video File *</label>
                <div class="file-upload-group" onclick="document.getElementById('wpFileUpload').click()">
                    <div style="font-size: 2em; margin-bottom: 10px;">üìπ</div>
                    <div class="upload-text">Click to upload or drag and drop</div>
                    <div style="font-size: 0.85em; color: #666;">MP4 video file</div>
                    <input type="file" id="wpFileUpload" accept=".mp4,video/mp4" required>
                    <div id="wpFileName" class="file-name"></div>
                </div>

                <label for="wpTitle">Post Title *</label>
                <input type="text" id="wpTitle" placeholder="Enter post title..." required>

                <label for="wpDescription">Description</label>
                <textarea id="wpDescription" placeholder="Enter post description..."></textarea>

                <label for="wpYoutubeUrl">YouTube Link (optional)</label>
                <input type="url" id="wpYoutubeUrl" placeholder="https://youtube.com/watch?v=...">

                <button type="submit" id="wpSubmitBtn">Publish to WordPress</button>
                <div id="wpStatus" class="status"></div>
            </form>
        </div>

        <!-- ============= TAB 4: FACEBOOK POSTING ============= -->
        <div id="fb-post" class="tab-content section">
            <h2>üë§ Facebook Posting</h2>
            <form id="fbPostForm">
                <label for="fbFileUpload">Select Video File *</label>
                <div class="file-upload-group" onclick="document.getElementById('fbFileUpload').click()">
                    <div style="font-size: 2em; margin-bottom: 10px;">üìπ</div>
                    <div class="upload-text">Click to upload or drag and drop</div>
                    <div style="font-size: 0.85em; color: #666;">MP4 video file</div>
                    <input type="file" id="fbFileUpload" accept=".mp4,video/mp4" required>
                    <div id="fbFileName" class="file-name"></div>
                </div>

                <label for="fbCaption">Caption</label>
                <textarea id="fbCaption" placeholder="Enter caption for your Facebook post..."></textarea>

                <button type="submit" id="fbSubmitBtn">Post to Facebook</button>
                <div id="fbStatus" class="status"></div>
            </form>
        </div>

        <!-- ============= TAB 5: INSTAGRAM POSTING ============= -->
        <div id="ig-post" class="tab-content section">
            <h2>üì∏ Instagram Posting</h2>
            <form id="igPostForm">
                <label for="igFileUpload">Select Video File *</label>
                <div class="file-upload-group" onclick="document.getElementById('igFileUpload').click()">
                    <div style="font-size: 2em; margin-bottom: 10px;">üìπ</div>
                    <div class="upload-text">Click to upload or drag and drop</div>
                    <div style="font-size: 0.85em; color: #666;">MP4 video file</div>
                    <input type="file" id="igFileUpload" accept=".mp4,video/mp4" required>
                    <div id="igFileName" class="file-name"></div>
                </div>

                <label for="igCaption">Caption</label>
                <textarea id="igCaption" placeholder="Enter caption for your Instagram post..."></textarea>

                <label>Posting Method</label>
                <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                    <label style="display: flex; align-items: center; margin: 0; font-weight: normal;">
                        <input type="radio" name="igPostType" value="api" checked style="width: auto; margin-right: 8px;">
                        Direct API
                    </label>
                    <label style="display: flex; align-items: center; margin: 0; font-weight: normal;">
                        <input type="radio" name="igPostType" value="web" style="width: auto; margin-right: 8px;">
                        Web Share
                    </label>
                </div>

                <button type="submit" id="igSubmitBtn">Post to Instagram</button>
                <div id="igStatus" class="status"></div>
            </form>
        </div>

        <!-- ============= TAB 6: VIDEOS LIBRARY ============= -->
        <div id="videos" class="tab-content section">
            <h2>üìπ Generated Videos</h2>
            <div id="videosList" class="video-grid">
                <div class="empty-message">Loading videos...</div>
            </div>
        </div>
    </div>

    <script>
        // ============= TAB SWITCHING =============
        function switchTab(tabId) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            // Deactivate all buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            const tab = document.getElementById(tabId);
            if (tab) {
                tab.classList.add('active');
                // Activate corresponding button (find by data-tab attribute)
                const btn = document.querySelector(`.tab-btn[data-tab="${tabId}"]`);
                if (btn) btn.classList.add('active');

                // Load videos when switching to videos tab
                if (tabId === 'videos') {
                    loadVideos();
                }
            }
        }

        // ============= CREDENTIAL STATUS CHECK =============
        async function checkCredentials() {
            try {
                const res = await fetch('/config/credentials');
                const creds = await res.json();

                // Facebook
                const fbBadge = document.getElementById('fb-status-badge');
                if (fbBadge) {
                    const fbDot = fbBadge.querySelector('span:first-child');
                    const fbText = fbBadge.querySelector('span:last-child');
                    if (creds.facebook.configured) {
                        fbDot.style.background = '#4CAF50';
                        fbText.textContent = '‚úì Facebook';
                        fbText.style.color = '#4CAF50';
                    } else {
                        fbDot.style.background = '#FF9800';
                        fbText.textContent = '‚ö† Facebook (not configured)';
                        fbText.style.color = '#FF9800';
                    }
                }

                // Instagram
                const igBadge = document.getElementById('ig-status-badge');
                if (igBadge) {
                    const igDot = igBadge.querySelector('span:first-child');
                    const igText = igBadge.querySelector('span:last-child');
                    if (creds.instagram.configured) {
                        igDot.style.background = '#4CAF50';
                        igText.textContent = '‚úì Instagram';
                        igText.style.color = '#4CAF50';
                    } else {
                        igDot.style.background = '#FF9800';
                        igText.textContent = '‚ö† Instagram (not configured)';
                        igText.style.color = '#FF9800';
                    }
                }

                // WordPress
                const wpBadge = document.getElementById('wp-status-badge');
                if (wpBadge) {
                    const wpDot = wpBadge.querySelector('span:first-child');
                    const wpText = wpBadge.querySelector('span:last-child');
                    if (creds.wordpress.configured) {
                        wpDot.style.background = '#4CAF50';
                        let wpLabel = '‚úì WordPress';
                        if (!creds.wordpress.verify_ssl) {
                            wpLabel += ' (SSL disabled)';
                        }
                        wpText.textContent = wpLabel;
                        wpText.style.color = '#4CAF50';
                    } else {
                        wpDot.style.background = '#FF9800';
                        wpText.textContent = '‚ö† WordPress (not configured)';
                        wpText.style.color = '#FF9800';
                    }
                    // Show prominent warning if SSL verification disabled
                    const sslWarning = document.getElementById('sslWarning');
                    if (sslWarning) {
                        if (creds.wordpress && creds.wordpress.verify_ssl === false) {
                            sslWarning.style.display = 'block';
                        } else {
                            sslWarning.style.display = 'none';
                        }
                    }
                }
            } catch (e) {
                console.error('Failed to check credentials:', e);
            }
        }
                    // add select-all / deselect-all controls
                    const controls = document.createElement('div');
                    controls.style.marginTop = '8px';
                    controls.innerHTML = '<button id="selectAll">Select all</button> <button id="deselectAll">Deselect all</button>';
                    previewDiv.appendChild(controls);
                    document.getElementById('selectAll').addEventListener('click', function (){
                        document.querySelectorAll('.preview-checkbox').forEach(b=>b.checked=true);
                    });
                    document.getElementById('deselectAll').addEventListener('click', function (){
                        document.querySelectorAll('.preview-checkbox').forEach(b=>b.checked=false);
                    });

                    // Load existing mapping into editor
                    const mapEditor = document.getElementById('mappingEditor');
                    if (mapEditor && mapEditor.value.trim() === '') {
                        try {
                            const r = await fetch('/rss_get_mapping');
                            if (r.ok) {
                                const j = await r.json();
                                mapEditor.value = JSON.stringify(j, null, 2);
                            }
                        } catch (e) {
                            // ignore
                        }
                    }

        // Check credentials on page load
        document.addEventListener('DOMContentLoaded', function(){
            checkCredentials();
            // If this page was rendered with an initialTab, open it
            try{
                if (typeof initialTab !== 'undefined' && initialTab) {
                    switchTab(initialTab);
                }
            }catch(e){/* ignore */}
        });

        // ============= FILE UPLOAD HANDLERS =============
        function setupFileUpload(fileInputId, fileNameId) {
            const fileInput = document.getElementById(fileInputId);
            const fileName = document.getElementById(fileNameId);
            
            if (!fileInput) return;
            
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    fileName.textContent = '‚úì ' + e.target.files[0].name;
                    fileName.style.color = '#66b2ff';
                } else {
                    fileName.textContent = '';
                }
            });
        }

        // Initialize file uploads
        setupFileUpload('wpFileUpload', 'wpFileName');
        setupFileUpload('fbFileUpload', 'fbFileName');
        setupFileUpload('igFileUpload', 'igFileName');

        // ============= FORM HANDLERS =============
        const form = document.getElementById('generateForm');
        const formLong = document.getElementById('generateFormLong');
        const statusDiv = document.getElementById('status');
        const statusDivLong = document.getElementById('statusLong');
        const submitBtn = document.getElementById('submitBtn');
        const submitBtnLong = document.getElementById('submitBtnLong');
        const videosList = document.getElementById('videosList');
        const providerSelect = document.getElementById('voice_provider');
        const modelSelect = document.getElementById('voice_model');
        const providerSelect2 = document.getElementById('voice_provider2');
        const modelSelect2 = document.getElementById('voice_model2');

        // Load videos on page load
        loadVideos();

        // Auto-load videos every 5 seconds
        setInterval(loadVideos, 5000);

        // Voice model lists
        const MODELS = {
            edge: [
                {id: 'en-US-GuyNeural', label: 'Edge ‚Äî en-US Guy (male)'} ,
                {id: 'en-US-AmberNeural', label: 'Edge ‚Äî en-US Amber (female)'} ,
                {id: 'hi-IN-MadhurNeural', label: 'Edge ‚Äî hi-IN Madhur (male)'} ,
                {id: 'hi-IN-SwaraNeural', label: 'Edge ‚Äî hi-IN Swara (female)'} ,
                {id: 'gu-IN-NiranjanNeural', label: 'Edge ‚Äî gu-IN Niranjan (male)'} ,
                {id: 'gu-IN-DhwaniNeural', label: 'Edge ‚Äî gu-IN Dhwani (female)'}
            ],
            eleven: [
                {id: '21m00Tcm4TlvDq8ikWAM', label: 'ElevenLabs ‚Äî Rachel'},
                {id: 'EXAVITQu4vr4xnSDxMaL', label: 'ElevenLabs ‚Äî Alloy'},
                {id: 'pNinE6OkJ8cz0Uj7sD', label: 'ElevenLabs ‚Äî Zeus'}
            ],
            gtts: [
                {id: 'en', label: 'gTTS ‚Äî English (en)'},
                {id: 'hi', label: 'gTTS ‚Äî Hindi (hi)'},
                {id: 'gu', label: 'gTTS ‚Äî Gujarati (gu)'}
            ],
            auto: [ {id: 'auto', label: 'Auto (choose best)'} ]
        };

        function populateModels(provider) {
            modelSelect.innerHTML = '';
            const list = MODELS[provider] || MODELS['auto'];
            list.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m.id;
                opt.textContent = m.label;
                modelSelect.appendChild(opt);
            });
        }

        // initialize
        if (providerSelect) {
            populateModels(providerSelect.value || 'auto');
            providerSelect.addEventListener('change', (e) => populateModels(e.target.value));
        }

        // Initialize second provider/model selectors for long form
        if (providerSelect2) {
            populateModels(providerSelect2.value || 'auto');
            providerSelect2.addEventListener('change', (e) => {
                const list = MODELS[e.target.value] || MODELS['auto'];
                modelSelect2.innerHTML = '';
                list.forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m.id;
                    opt.textContent = m.label;
                    modelSelect2.appendChild(opt);
                });
            });
        }

        if (form && submitBtn && statusDiv) {
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const headline = document.getElementById('headline').value;
                const description = document.getElementById('description').value;
                const language = document.getElementById('language').value;

                if (!headline.trim()) {
                    showStatus('Please enter a headline', 'error');
                    return;
                }
                
                if (!description.trim()) {
                    showStatus('Please enter a description', 'error');
                    return;
                }

            submitBtn.disabled = true;
            showStatus('<span class="spinner"></span> Generating video... This may take 1-2 minutes', 'loading');

            try {
                const formData = new FormData();
                formData.append('headline', headline);
                formData.append('description', description);
                formData.append('language', language);
                // Voice uses default female voice with fallback to male
                formData.append('voice_provider', document.getElementById('voice_provider').value);
                formData.append('voice_model', document.getElementById('voice_model').value);
                formData.append('video_length', document.getElementById('video_length').value);

                const response = await fetch('/generate', {
                    method: 'POST',
                    body: formData
                });

                let data = null;
                const contentType = response.headers.get('content-type') || '';
                if (contentType.includes('application/json')) {
                    try {
                        data = await response.json();
                    } catch (e) {
                        data = { error: 'Invalid JSON response from server' };
                    }
                } else {
                    const text = await response.text();
                    try {
                        data = JSON.parse(text || '{}');
                    } catch (e) {
                        data = { error: text || 'Empty response from server' };
                    }
                }

                if (response.ok) {
                    showStatus('‚úì Video generated successfully!', 'success');
                    form.reset();
                    setTimeout(() => {
                        statusDiv.classList.remove('show');
                    }, 3000);
                    loadVideos();
                    switchTab('videos'); // Switch to videos tab to show the new video
                } else {
                    showStatus('‚úó ' + (data.error || 'Failed to generate video'), 'error');
                }
            } catch (error) {
                showStatus('‚úó Error: ' + error.message, 'error');
            } finally {
                submitBtn.disabled = false;
            }
            });
        }

        // LONG FORM EVENT LISTENER
        if (formLong && submitBtnLong && statusDivLong) {
            formLong.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const headline = document.getElementById('headline2').value;
                const description = document.getElementById('description2').value;
                const language = document.getElementById('language2').value;

                if (!headline.trim()) {
                    const status = document.getElementById('statusLong');
                    showStatusInDiv(status, 'Please enter a headline', 'error');
                    return;
                }
                
                if (!description.trim()) {
                    const status = document.getElementById('statusLong');
                    showStatusInDiv(status, 'Please enter a description', 'error');
                    return;
                }

                submitBtnLong.disabled = true;
                const status = document.getElementById('statusLong');
                showStatusInDiv(status, '<span class="spinner"></span> Generating video... This may take 1-2 minutes', 'loading');

                try {
                    const formData = new FormData();
                    formData.append('headline', headline);
                    formData.append('description', description);
                    formData.append('language', language);
                    formData.append('voice_provider', document.getElementById('voice_provider2').value);
                    formData.append('voice_model', document.getElementById('voice_model2').value);
                    formData.append('video_length', document.getElementById('video_length2').value);

                    const response = await fetch('/generate-long', {
                        method: 'POST',
                        body: formData
                    });

                    let data = await response.json().catch(() => ({}));

                    if (response.ok) {
                        showStatusInDiv(status, '‚úì Video generated successfully!', 'success');
                        formLong.reset();
                        setTimeout(() => {
                            status.classList.remove('show');
                        }, 3000);
                        loadVideos();
                        switchTab('videos'); // Switch to videos tab to show the new video
                    } else {
                        const detail = data.error || data.traceback || data.message || JSON.stringify(data);
                        showStatusInDiv(status, '‚úó ' + (detail || 'Failed to generate video'), 'error');
                    }
                } catch (error) {
                    showStatusInDiv(status, '‚úó Error: ' + error.message, 'error');
                } finally {
                    submitBtnLong.disabled = false;
                }
            });
        }

        // WORDPRESS POSTING FORM
        const wpPostForm = document.getElementById('wpPostForm');
        if (wpPostForm) {
            wpPostForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const fileInput = document.getElementById('wpFileUpload');
                const title = document.getElementById('wpTitle').value.trim();
                const description = document.getElementById('wpDescription').value.trim();
                const youtubeUrl = document.getElementById('wpYoutubeUrl').value.trim();
                const status = document.getElementById('wpStatus');

                if (!fileInput.files.length) {
                    showStatusInDiv(status, 'Please select a video file', 'error');
                    return;
                }

                if (!title) {
                    showStatusInDiv(status, 'Title is required', 'error');
                    return;
                }

                showStatusInDiv(status, '<span class="spinner"></span> Uploading to WordPress...', 'loading');
                submitBtnLong.disabled = true;

                try {
                    const formData = new FormData();
                    formData.append('video', fileInput.files[0]);
                    formData.append('headline', title);
                    formData.append('description', description);
                    formData.append('youtube_url', youtubeUrl);

                    const response = await fetch('/wordpress/post', {
                        method: 'POST',
                        body: formData
                    });

                    let data = await response.json().catch(() => ({}));

                    if (response.ok) {
                        showStatusInDiv(status, '‚úì Posted to WordPress successfully!', 'success');
                        wpPostForm.reset();
                        document.getElementById('wpFileName').textContent = '';
                        setTimeout(() => status.classList.remove('show'), 3000);
                    } else {
                        showStatusInDiv(status, '‚úó ' + (data.error || 'Upload failed'), 'error');
                    }
                } catch (error) {
                    showStatusInDiv(status, '‚úó Error: ' + error.message, 'error');
                } finally {
                    submitBtnLong.disabled = false;
                }
            });
        }

        // FACEBOOK POSTING FORM
        const fbPostForm = document.getElementById('fbPostForm');
        if (fbPostForm) {
            fbPostForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const fileInput = document.getElementById('fbFileUpload');
                const caption = document.getElementById('fbCaption').value.trim();
                const status = document.getElementById('fbStatus');

                if (!fileInput.files.length) {
                    showStatusInDiv(status, 'Please select a video file', 'error');
                    return;
                }

                showStatusInDiv(status, '<span class="spinner"></span> Posting to Facebook...', 'loading');
                const fbSubmitBtn = document.getElementById('fbSubmitBtn');
                fbSubmitBtn.disabled = true;

                try {
                    const formData = new FormData();
                    formData.append('video', fileInput.files[0]);
                    formData.append('caption', caption);

                    const response = await fetch('/facebook/post', {
                        method: 'POST',
                        body: formData
                    });

                    let data = await response.json().catch(() => ({}));

                    if (response.ok) {
                        showStatusInDiv(status, '‚úì Posted to Facebook successfully!', 'success');
                        fbPostForm.reset();
                        document.getElementById('fbFileName').textContent = '';
                        setTimeout(() => status.classList.remove('show'), 3000);
                    } else {
                        showStatusInDiv(status, '‚úó ' + (data.error || 'Upload failed'), 'error');
                    }
                } catch (error) {
                    showStatusInDiv(status, '‚úó Error: ' + error.message, 'error');
                } finally {
                    fbSubmitBtn.disabled = false;
                }
            });
        }

        // INSTAGRAM POSTING FORM
        const igPostForm = document.getElementById('igPostForm');
            // Story UI management
            const storiesContainer = document.getElementById('storiesContainer');
            const addStoryBtn = document.getElementById('addStoryBtn');
            const clearStoriesBtn = document.getElementById('clearStoriesBtn');

            function createStoryBlock(index, title = '', desc = '') {
                const wrapper = document.createElement('div');
                wrapper.className = 'story-block';
                wrapper.style.border = '1px solid rgba(255,255,255,0.04)';
                wrapper.style.padding = '10px';
                wrapper.style.marginBottom = '8px';

                wrapper.innerHTML = `
                    <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:8px;">
                        <strong>Story ${index+1}</strong>
                        <div style="display:flex;gap:6px">
                            <button type="button" class="move-up">‚Üë</button>
                            <button type="button" class="move-down">‚Üì</button>
                            <button type="button" class="remove-story">‚úñ</button>
                        </div>
                    </div>
                    <label>Headline</label>
                    <input type="text" name="story_headline_${index}" class="story-headline" value="${title}" placeholder="Story headline" required>

                    <label>Description</label>
                    <textarea name="story_description_${index}" class="story-description" placeholder="Story description" required>${desc}</textarea>

                    <div style="display:flex;gap:8px;flex-wrap:wrap;">
                        <div style="flex:1;min-width:200px;">
                            <label>Source</label>
                            <input type="text" name="story_source_${index}" class="story-source" placeholder="Source name (e.g. Reuters)">
                        </div>
                        <div style="flex:1;min-width:200px;">
                            <label>Source URL</label>
                            <input type="url" name="story_source_url_${index}" class="story-source-url" placeholder="https://">
                        </div>
                        <div style="flex:1;min-width:160px;">
                            <label>Date</label>
                            <input type="date" name="story_date_${index}" class="story-date">
                        </div>
                        <div style="flex:1;min-width:160px;">
                            <label>Tags</label>
                            <input type="text" name="story_tags_${index}" class="story-tags" placeholder="tag1, tag2">
                        </div>
                    </div>

                    <label>Optional image/video (green screen)</label>
                    <input type="file" name="story_file_${index}" accept="image/*,video/*">
                `;

                storiesContainer.appendChild(wrapper);

                wrapper.querySelector('.remove-story').addEventListener('click', () => {
                    wrapper.remove();
                    rebuildStoryIndexes();
                });
                wrapper.querySelector('.move-up').addEventListener('click', () => {
                    const prev = wrapper.previousElementSibling;
                    if (prev) storiesContainer.insertBefore(wrapper, prev);
                    rebuildStoryIndexes();
                });
                wrapper.querySelector('.move-down').addEventListener('click', () => {
                    const next = wrapper.nextElementSibling;
                    if (next) storiesContainer.insertBefore(next, wrapper);
                    rebuildStoryIndexes();
                });
            }

            function rebuildStoryIndexes() {
                Array.from(storiesContainer.children).forEach((child, i) => {
                    child.querySelector('strong').textContent = `Story ${i+1}`;
                    const h = child.querySelector('.story-headline');
                    const d = child.querySelector('.story-description');
                    const f = child.querySelector('input[type=file]');
                    const s = child.querySelector('.story-source');
                    const su = child.querySelector('.story-source-url');
                    const t = child.querySelector('.story-tags');
                    const dt = child.querySelector('.story-date');
                    if (h) h.name = `story_headline_${i}`;
                    if (d) d.name = `story_description_${i}`;
                    if (f) f.name = `story_file_${i}`;
                    if (s) s.name = `story_source_${i}`;
                    if (su) su.name = `story_source_url_${i}`;
                    if (t) t.name = `story_tags_${i}`;
                    if (dt) dt.name = `story_date_${i}`;
                });
            }

            // initialize with one story
            createStoryBlock(0);

            addStoryBtn.addEventListener('click', () => {
                const idx = storiesContainer.children.length;
                createStoryBlock(idx);
            });

            clearStoriesBtn.addEventListener('click', () => {
                storiesContainer.innerHTML = '';
                createStoryBlock(0);
            });

            // Submit handler collects stories into JSON and appends files
            formLong.addEventListener('submit', async (e) => {
                e.preventDefault();

                const status = document.getElementById('statusLong');
                submitBtnLong.disabled = true;
                showStatusInDiv(status, '<span class="spinner"></span> Generating video... This may take several minutes', 'loading');

                try {
                    const formData = new FormData();
                    const stories = [];
                    Array.from(storiesContainer.children).forEach((child, i) => {
                        const h = (child.querySelector('.story-headline') || {}).value || '';
                        const d = (child.querySelector('.story-description') || {}).value || '';
                        const s = (child.querySelector('.story-source') || {}).value || '';
                        const su = (child.querySelector('.story-source-url') || {}).value || '';
                        const t = (child.querySelector('.story-tags') || {}).value || '';
                        const dt = (child.querySelector('.story-date') || {}).value || '';
                        stories.push({ headline: h, description: d, source: s, source_url: su, tags: t, date: dt });
                        const f = child.querySelector('input[type=file]');
                        if (f && f.files && f.files[0]) {
                            formData.append(`story_file_${i}`, f.files[0]);
                        }
                    });

                    formData.append('stories', JSON.stringify(stories));
                    formData.append('language', document.getElementById('language2').value);
                    formData.append('voice_provider', document.getElementById('voice_provider2').value);
                    formData.append('video_length', document.getElementById('video_length2').value);

                    const response = await fetch('/generate-long', {
                        method: 'POST',
                        body: formData
                    });

                    let data = await response.json().catch(() => ({}));

                    if (response.ok) {
                        showStatusInDiv(status, '‚úì Video generated successfully!', 'success');
                        formLong.reset();
                        storiesContainer.innerHTML = '';
                        createStoryBlock(0);
                        setTimeout(() => { status.classList.remove('show'); }, 3000);
                        loadVideos();
                    } else {
                        showStatusInDiv(status, '‚úó ' + (data.error || 'Failed to generate video'), 'error');
                    }
                } catch (error) {
                    showStatusInDiv(status, '‚úó Error: ' + error.message, 'error');
                } finally {
                    submitBtnLong.disabled = false;
                }
            });
        
            });

        function createLong() {
            document.getElementById('video_length').value = 'long';
            submitBtn.click();
        }

        function promptPost(provider) {
            const filename = prompt('Enter video filename (e.g. video_2026...mp4) to post:');
            if (!filename) return;
            let endpoint = '/' + provider + '/post';
            const form = new FormData();
            form.append('filename', filename);
            if (provider === 'wordpress') {
                const headline = prompt('Enter headline (optional):');
                if (headline) form.append('headline', headline);
            } else if (provider === 'facebook' || provider === 'instagram') {
                const caption = prompt('Enter caption (optional):');
                if (caption) form.append('caption', caption);
            } else if (provider === 'youtube') {
                const title = prompt('Enter title (optional):');
                const description = prompt('Enter description (optional):');
                if (title) form.append('title', title);
                if (description) form.append('description', description);
            }

            fetch(endpoint, { method: 'POST', body: form })
                .then(r => r.json())
                .then(d => alert(JSON.stringify(d)))
                .catch(e => alert('Error: ' + e.message));
        }

        function showStatus(message, type) {
            statusDiv.innerHTML = message;
            statusDiv.className = `status show ${type}`;
        }

        function showStatusInDiv(statusElement, message, type) {
            if (!statusElement) return;
            statusElement.innerHTML = message;
            statusElement.className = `status show ${type}`;
        }

        async function loadVideos() {
            try {
                const response = await fetch('/videos');
                let data = null;
                const contentType = response.headers.get('content-type') || '';
                if (contentType.includes('application/json')) {
                    try {
                        data = await response.json();
                    } catch (e) {
                        console.error('Failed to parse /videos JSON:', e);
                        data = { videos: [] };
                    }
                } else {
                    const text = await response.text();
                    try {
                        data = JSON.parse(text || '{}');
                    } catch (e) {
                        console.error('Unexpected /videos response:', text);
                        data = { videos: [] };
                    }
                }

                if (data.videos.length === 0) {
                    videosList.innerHTML = '<div class="empty-message">No videos generated yet</div>';
                    return;
                }

                videosList.innerHTML = data.videos.map(video => `
                    <div class="video-card">
                        <div class="video-title">${escapeHtml(video.headline)}</div>
                        <div class="video-meta">
                            <div class="video-meta-item">
                                <strong>Created:</strong> ${new Date(video.created_at).toLocaleString()}
                            </div>
                            <div class="video-meta-item">
                                <strong>Size:</strong> ${video.size_mb} MB
                            </div>
                        </div>
                        <div>
                            <span class="language-badge">${video.language.toUpperCase()}</span>
                            <span class="size-badge">${video.size_mb} MB</span>
                        </div>
                        <video controls style="width: 100%; max-height: 200px; margin: 10px 0;">
                            <source src="/video/${video.filename}" type="video/mp4">
                            Your browser does not support the video tag.
                        </video>
                        <div class="video-actions">
                            <button class="download-btn" onclick="downloadVideo('${video.filename}', '${escapeHtml(video.headline)}')">‚¨á Download</button>
                            <button class="delete-btn" onclick="deleteVideo('${video.filename}')">üóë Delete</button>
                            <button class="share-fb" onclick="shareFacebook('${video.filename}', '${escapeHtml(video.headline)}')">f Share</button>
                            <button class="share-ig" onclick="shareInstagram('${video.filename}', '${escapeHtml(video.headline)}')">üì∏ IG</button>
                            <button class="share-wp" onclick="shareWordpress('${video.filename}', '${escapeHtml(video.headline)}')">W Publish</button>
                        </div>
                        <div class="post-info" id="post-info-${video.filename}"></div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading videos:', error);
            }
        }

        function downloadVideo(filename, headline) {
            // Show loading indicator
            const link = document.createElement('a');
            link.style.pointerEvents = 'none';
            link.href = `/video/${filename}`;
            link.download = `${headline.substring(0, 30)}_${filename}`;
            
            // Trigger download
            document.body.appendChild(link);
            link.click();
            
            // Clean up
            setTimeout(() => {
                document.body.removeChild(link);
            }, 100);
        }

        async function deleteVideo(filename) {
            if (!confirm('Are you sure you want to delete this video?')) {
                return;
            }

            try {
                const response = await fetch(`/video/${filename}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    loadVideos();
                } else {
                    alert('Failed to delete video');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Social sharing helpers
        function shareFacebook(filename, headline) {
            openFacebookModal(filename, headline);
        }

        async function shareInstagram(filename, headline) {
            openInstagramModal(filename, headline);
        }

        async function shareWordpress(filename, headline) {
            openWordPressModal(filename, headline);
        }

        function embedPost(containerId, url) {
            const container = document.getElementById(containerId);
            if (!container) return;
            // Remove existing embed if any
            const existing = container.querySelector('iframe.embed-preview');
            if (existing) {
                existing.remove();
                return;
            }

            const iframe = document.createElement('iframe');
            iframe.className = 'embed-preview';
            iframe.src = url;
            iframe.style.width = '100%';
            iframe.style.height = '400px';
            iframe.style.border = '1px solid rgba(255,255,255,0.06)';
            container.appendChild(iframe);
        }

        // ============= MODAL FUNCTIONS =============
        let currentModalData = {};

        function openModal(modalId, modalData = {}) {
            currentModalData = modalData;
            document.getElementById(modalId).classList.add('show');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
            currentModalData = {};
        }

        function closeAllModals() {
            document.querySelectorAll('.modal').forEach(m => m.classList.remove('show'));
            currentModalData = {};
        }

        // WordPress Modal
        async function openWordPressModal(filename, headline) {
            openModal('wordpressModal', { filename, headline });
            document.getElementById('wpTitle').value = headline || '';
            document.getElementById('wpDescription').value = '';
            document.getElementById('wpYoutubeUrl').value = '';
        }

        async function submitWordPressForm() {
            const filename = currentModalData.filename;
            const title = document.getElementById('wpTitle').value.trim();
            const description = document.getElementById('wpDescription').value.trim();
            const youtubeUrl = document.getElementById('wpYoutubeUrl').value.trim();

            if (!title) {
                alert('Title is required');
                return;
            }

            closeAllModals();

            const postInfoId = `post-info-${filename}`;
            const postInfo = document.getElementById(postInfoId);
            const maxAttempts = 3;

            async function attemptPublish(attempt = 1) {
                postInfo.innerHTML = `<div class="status loading show"><span class="spinner"></span> Publishing to WordPress... (attempt ${attempt}/${maxAttempts})</div>`;

                try {
                    const formData = new FormData();
                    formData.append('filename', filename);
                    formData.append('headline', title);
                    formData.append('description', description);
                    formData.append('youtube_url', youtubeUrl);

                    const res = await fetch('/wordpress/post', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await res.json().catch(() => ({}));

                    if (res.ok && data.post) {
                        const postLink = data.post.link || data.post.guid?.rendered || data.post.url || '';
                        let html = `<div class="status success show">‚úì Published to WordPress</div>`;
                        if (postLink) {
                            html += `<div style="margin-top:8px">Post: <a href="${postLink}" target="_blank" rel="noopener">${postLink}</a></div>`;
                            html += `<div class="post-actions">`;
                            html += `<button onclick="window.open('${postLink}','_blank')">Open</button>`;
                            html += `<button onclick="embedPost('${postInfoId}','${postLink}')">Embed</button>`;
                            html += `</div>`;
                        } else {
                            html += `<div style="margin-top:8px">Post created (ID: ${data.post.id || 'unknown'})</div>`;
                        }
                        postInfo.innerHTML = html;
                        setTimeout(() => { if (postInfo) postInfo.querySelector('.status')?.classList.remove('show'); }, 3000);
                    } else {
                        const err = data.error || res.statusText || 'Unknown error';
                        if (attempt < maxAttempts) {
                            postInfo.innerHTML = `<div class="status error show">‚úó Publish failed: ${err} ‚Äî retrying...</div>`;
                            await new Promise(r => setTimeout(r, 1200));
                            return attemptPublish(attempt + 1);
                        } else {
                            postInfo.innerHTML = `<div class="status error show">‚úó Publish failed: ${err}</div><div class="post-actions"><button onclick="openWordPressModal('${filename}','${title}')">Retry</button></div>`;
                        }
                    }
                } catch (e) {
                    if (attempt < maxAttempts) {
                        postInfo.innerHTML = `<div class="status error show">‚úó Error: ${e.message} ‚Äî retrying...</div>`;
                        await new Promise(r => setTimeout(r, 1200));
                        return attemptPublish(attempt + 1);
                    }
                    postInfo.innerHTML = `<div class="status error show">‚úó Error: ${e.message}</div><div class="post-actions"><button onclick="openWordPressModal('${filename}','${title}')">Retry</button></div>`;
                }
            }

            attemptPublish();
        }

        // Facebook Modal
        async function openFacebookModal(filename, headline) {
            openModal('facebookModal', { filename, headline });
            document.getElementById('fbCaption').value = '';
        }

        async function submitFacebookForm() {
            const filename = currentModalData.filename;
            const caption = document.getElementById('fbCaption').value.trim();

            closeAllModals();

            const postInfoId = `post-info-${filename}`;
            const postInfo = document.getElementById(postInfoId);

            try {
                postInfo.innerHTML = `<div class="status loading show"><span class="spinner"></span> Posting to Facebook...</div>`;

                const formData = new FormData();
                formData.append('filename', filename);
                formData.append('caption', caption);

                const res = await fetch('/facebook/post', {
                    method: 'POST',
                    body: formData
                });

                const data = await res.json().catch(() => ({}));

                if (res.ok && data.status === 'posted') {
                    postInfo.innerHTML = `<div class="status success show">‚úì Posted to Facebook</div>`;
                    setTimeout(() => { if (postInfo) postInfo.querySelector('.status')?.classList.remove('show'); }, 3000);
                } else {
                    const err = data.error || res.statusText || 'Unknown error';
                    postInfo.innerHTML = `<div class="status error show">‚úó Failed: ${err}</div><div class="post-actions"><button onclick="openFacebookModal('${filename}','')">Retry</button></div>`;
                }
            } catch (e) {
                postInfo.innerHTML = `<div class="status error show">‚úó Error: ${e.message}</div><div class="post-actions"><button onclick="openFacebookModal('${filename}','')">Retry</button></div>`;
            }
        }

        // Instagram Modal
        async function openInstagramModal(filename, headline) {
            openModal('instagramModal', { filename, headline });
            document.getElementById('igCaption').value = '';
        }

        async function submitInstagramForm() {
            const filename = currentModalData.filename;
            const caption = document.getElementById('igCaption').value.trim();
            const postType = document.querySelector('input[name="igPostType"]:checked')?.value || 'api';

            closeAllModals();

            const postInfoId = `post-info-${filename}`;
            const postInfo = document.getElementById(postInfoId);

            if (postType === 'web') {
                // Web Share method
                const videoUrl = window.location.origin + `/video/${filename}`;
                if (navigator.share) {
                    try {
                        await navigator.share({
                            title: 'Check this out',
                            text: caption || 'Generated video',
                            url: videoUrl
                        });
                        postInfo.innerHTML = `<div class="status success show">‚úì Shared to Instagram</div>`;
                        setTimeout(() => { if (postInfo) postInfo.querySelector('.status')?.classList.remove('show'); }, 3000);
                        return;
                    } catch (e) {
                        console.warn('Web Share failed:', e);
                    }
                }
                // Fallback
                const msg = `Open link to download and upload to Instagram:\n${videoUrl}`;
                if (confirm(msg + '\n\nCopy to clipboard?')) {
                    await navigator.clipboard.writeText(videoUrl);
                    alert('Link copied. Download the video and post to Instagram.');
                }
            } else {
                // API method
                try {
                    postInfo.innerHTML = `<div class="status loading show"><span class="spinner"></span> Posting to Instagram...</div>`;

                    const formData = new FormData();
                    formData.append('filename', filename);
                    formData.append('caption', caption);

                    const res = await fetch('/instagram/post', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await res.json().catch(() => ({}));

                    if (res.ok && data.status === 'posted') {
                        postInfo.innerHTML = `<div class="status success show">‚úì Posted to Instagram</div>`;
                        setTimeout(() => { if (postInfo) postInfo.querySelector('.status')?.classList.remove('show'); }, 3000);
                    } else {
                        const err = data.error || res.statusText || 'Unknown error';
                        postInfo.innerHTML = `<div class="status error show">‚úó Failed: ${err}</div><div class="post-actions"><button onclick="openInstagramModal('${filename}','')">Retry</button></div>`;
                    }
                } catch (e) {
                    postInfo.innerHTML = `<div class="status error show">‚úó Error: ${e.message}</div><div class="post-actions"><button onclick="openInstagramModal('${filename}','')">Retry</button></div>`;
                }
            }
        }

        // Close modals on outside click
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                closeAllModals();
            }
        }
    </script>

    <!-- WordPress Modal -->
    <div id="wordpressModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìù WordPress Post</h2>
                <button class="modal-close" onclick="closeAllModals()">&times;</button>
            </div>
            <div class="modal-body">
                <label for="wpTitle">Title *</label>
                <input type="text" id="wpTitle" placeholder="Enter post title..." required>

                <label for="wpDescription">Description</label>
                <textarea id="wpDescription" placeholder="Enter post description..."></textarea>

                <label for="wpYoutubeUrl">YouTube Link (optional)</label>
                <input type="url" id="wpYoutubeUrl" placeholder="https://youtube.com/watch?v=...">
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeAllModals()">Cancel</button>
                <button class="btn-submit" onclick="submitWordPressForm()">Publish</button>
            </div>
        </div>
    </div>

    <!-- Facebook Modal -->
    <div id="facebookModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üë§ Facebook Post</h2>
                <button class="modal-close" onclick="closeAllModals()">&times;</button>
            </div>
            <div class="modal-body">
                <label for="fbCaption">Caption</label>
                <textarea id="fbCaption" placeholder="Enter caption for your Facebook post..."></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeAllModals()">Cancel</button>
                <button class="btn-submit" onclick="submitFacebookForm()">Post</button>
            </div>
        </div>
    </div>

    <!-- Instagram Modal -->
    <div id="instagramModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üì∏ Instagram Post</h2>
                <button class="modal-close" onclick="closeAllModals()">&times;</button>
            </div>
            <div class="modal-body">
                <label for="igCaption">Caption</label>
                <textarea id="igCaption" placeholder="Enter caption for your Instagram post..."></textarea>

                <label>Posting Method</label>
                <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                    <label style="display: flex; align-items: center; margin: 0; font-weight: normal;">
                        <input type="radio" name="igPostType" value="api" checked style="width: auto; margin-right: 8px;">
                        Direct API
                    </label>
                    <label style="display: flex; align-items: center; margin: 0; font-weight: normal;">
                        <input type="radio" name="igPostType" value="web" style="width: auto; margin-right: 8px;">
                        Web Share
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeAllModals()">Cancel</button>
                <button class="btn-submit" onclick="submitInstagramForm()">Post</button>
            </div>
        </div>
    </div>

{% endblock %}