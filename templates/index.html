<!DOCTYPE html>
<html>
<head>
    <title>Grahak AI News Studio</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: #fff;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        
        .section {
            background: rgba(20, 20, 20, 0.8);
            border: 1px solid rgba(30, 144, 255, 0.12);
            border-radius: 10px;
            padding: 30px;
            backdrop-filter: blur(10px);
        }
        
        h1 {
            grid-column: 1 / -1;
            text-align: center;
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #66b2ff, #0066ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .subtitle {
            grid-column: 1 / -1;
            text-align: center;
            color: #aaa;
            margin-bottom: 30px;
            font-size: 0.9em;
        }
        
        h2 {
            color: #66b2ff;
            margin-bottom: 20px;
            font-size: 1.5em;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #ccc;
            font-weight: 600;
            font-size: 0.95em;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 12px;
            margin: 0 0 20px 0;
            border-radius: 5px;
            border: 1px solid rgba(70, 130, 180, 0.15);
            background: rgba(40, 40, 40, 0.8);
            color: #fff;
            font-family: inherit;
            font-size: 1em;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #66b2ff;
            box-shadow: 0 0 10px rgba(102, 178, 255, 0.25);
        }
        
        textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        button {
            padding: 12px 30px;
            background: linear-gradient(135deg, #66b2ff, #0066ff);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1em;
            transition: all 0.3s ease;
            width: 100%;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 178, 255, 0.28);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .status {
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            display: none;
        }
        
        .status.show {
            display: block;
        }
        
        .status.success {
            background: rgba(0, 128, 0, 0.2);
            border: 1px solid rgba(0, 200, 0, 0.5);
            color: #90EE90;
        }
        
        .status.error {
            background: rgba(30, 144, 255, 0.08);
            border: 1px solid rgba(30, 144, 255, 0.18);
            color: #66b2ff;
        }
        
        .status.loading {
            background: rgba(100, 150, 255, 0.2);
            border: 1px solid rgba(100, 149, 237, 0.5);
            color: #87CEEB;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: #87CEEB;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }
        
        .video-card {
            background: rgba(30, 30, 30, 0.8);
            border: 1px solid rgba(30, 144, 255, 0.12);
            border-radius: 8px;
            padding: 15px;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .video-card:hover {
            border-color: #66b2ff;
            box-shadow: 0 0 15px rgba(102, 178, 255, 0.16);
        }
        
        .video-title {
            color: #66b2ff;
            font-weight: 600;
            margin-bottom: 8px;
            word-break: break-word;
            font-size: 0.95em;
        }
        
        .video-meta {
            font-size: 0.85em;
            color: #aaa;
            margin-bottom: 10px;
        }
        
        .video-meta-item {
            margin: 5px 0;
        }
        
        .video-actions {
            display: flex;
            gap: 10px;
            margin-top: 12px;
        }
        
        .video-actions button {
            flex: 1;
            padding: 8px 12px;
            font-size: 0.85em;
            margin: 0;
        }
        
        .video-actions .delete-btn {
            background: linear-gradient(135deg, #0044aa, #002244);
        }
        .video-actions .share-fb {
            background: linear-gradient(135deg, #1877f2, #0052cc);
        }
        .video-actions .share-ig {
            background: linear-gradient(135deg, #7a4fe3, #ff7a59);
        }
        .video-actions .share-wp {
            background: linear-gradient(135deg, #21759b, #0b6a83);
        }
        
        .video-actions .download-btn {
            background: linear-gradient(135deg, #00aa00, #006600);
        }
        
        .empty-message {
            text-align: center;
            color: #666;
            padding: 40px 20px;
            font-size: 1.1em;
        }
        
        .language-badge {
            display: inline-block;
            background: rgba(30, 144, 255, 0.6);
            color: #fff;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 0.75em;
            margin-top: 8px;
        }
        .post-info {
            margin-top: 12px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 6px;
            font-size: 0.9em;
            color: #cfeefe;
        }
        .post-info a {
            color: #bfe4ff;
            text-decoration: underline;
        }
        .post-actions {
            margin-top: 8px;
            display: flex;
            gap: 8px;
        }
        
        .size-badge {
            display: inline-block;
            background: rgba(100, 100, 100, 0.5);
            color: #fff;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 0.75em;
            margin-left: 5px;
        }
        
        @media (max-width: 1024px) {
            .container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>

    <h1>üé¨ Grahak Chetna AI News Studio</h1>
    <p class="subtitle">Generate Professional News Videos with AI Narration</p>

    <div class="menu" style="display:flex; gap:10px; justify-content:center; margin-bottom:18px;">
        <button onclick="createShort()" style="width:auto; padding:10px 18px;">Create Short Video</button>
        <button onclick="createLong()" style="width:auto; padding:10px 18px;">Create Long Video</button>
        <button onclick="promptPost('wordpress')" style="width:auto; padding:10px 18px;">WordPress Posting</button>
        <button onclick="promptPost('facebook')" style="width:auto; padding:10px 18px;">Facebook Posting</button>
        <button onclick="promptPost('instagram')" style="width:auto; padding:10px 18px;">Instagram Posting</button>
        <button onclick="promptPost('youtube')" style="width:auto; padding:10px 18px;">YouTube Posting</button>
    </div>

    <div class="container">
        <!-- LEFT: Generator Form -->
        <div class="section">
            <h2>üìù Create Video</h2>
            
            <form id="generateForm">
                <label for="headline">Headline</label>
                <input type="text" id="headline" name="headline" placeholder="Breaking News: Major Development..." required>

                <label for="description">Description</label>
                <textarea id="description" name="description" placeholder="Provide detailed description of the news story..." required></textarea>

                <label for="language">Language</label>
                <select id="language" name="language" required>
                    <option value="english">üá¨üáß English</option>
                    <option value="hindi">üáÆüá≥ Hindi</option>
                    <option value="gujarati">üáÆüá≥ Gujarati</option>
                </select>

                <input type="hidden" id="video_length" name="video_length" value="full">

                <label for="voice_gender">Voice</label>
                <select id="voice_gender" name="female_voice" required>
                    <option value="false">Male</option>
                    <option value="true">Female</option>
                </select>

                <label for="voice_provider">Voice Provider</label>
                <select id="voice_provider" name="voice_provider">
                    <option value="auto">Auto (recommended)</option>
                    <option value="edge">Edge TTS</option>
                    <option value="eleven">ElevenLabs</option>
                    <option value="gtts">gTTS</option>
                </select>

                <label for="voice_model">Voice Model</label>
                <select id="voice_model" name="voice_model">
                    <option value="auto">Auto</option>
                </select>

                <button type="submit" id="submitBtn">Generate Video</button>
                
                <div id="status" class="status"></div>
            </form>
        </div>

        <!-- RIGHT: Videos Library -->
        <div class="section">
            <h2>üìπ Generated Videos</h2>
            <div id="videosList" class="video-grid">
                <div class="empty-message">Loading videos...</div>
            </div>
        </div>
    </div>

    <script>
        const form = document.getElementById('generateForm');
        const statusDiv = document.getElementById('status');
        const submitBtn = document.getElementById('submitBtn');
        const videosList = document.getElementById('videosList');
        const providerSelect = document.getElementById('voice_provider');
        const modelSelect = document.getElementById('voice_model');

        // Load videos on page load
        loadVideos();

        // Auto-load videos every 5 seconds
        setInterval(loadVideos, 5000);

        // Voice model lists
        const MODELS = {
            edge: [
                {id: 'en-US-GuyNeural', label: 'Edge ‚Äî en-US Guy (male)'} ,
                {id: 'en-US-AmberNeural', label: 'Edge ‚Äî en-US Amber (female)'} ,
                {id: 'hi-IN-MadhurNeural', label: 'Edge ‚Äî hi-IN Madhur (male)'} ,
                {id: 'hi-IN-SwaraNeural', label: 'Edge ‚Äî hi-IN Swara (female)'} ,
                {id: 'gu-IN-NiranjanNeural', label: 'Edge ‚Äî gu-IN Niranjan (male)'} ,
                {id: 'gu-IN-DhwaniNeural', label: 'Edge ‚Äî gu-IN Dhwani (female)'}
            ],
            eleven: [
                {id: '21m00Tcm4TlvDq8ikWAM', label: 'ElevenLabs ‚Äî Rachel'},
                {id: 'EXAVITQu4vr4xnSDxMaL', label: 'ElevenLabs ‚Äî Alloy'},
                {id: 'pNinE6OkJ8cz0Uj7sD', label: 'ElevenLabs ‚Äî Zeus'}
            ],
            gtts: [
                {id: 'en', label: 'gTTS ‚Äî English (en)'},
                {id: 'hi', label: 'gTTS ‚Äî Hindi (hi)'},
                {id: 'gu', label: 'gTTS ‚Äî Gujarati (gu)'}
            ],
            auto: [ {id: 'auto', label: 'Auto (choose best)'} ]
        };

        function populateModels(provider) {
            modelSelect.innerHTML = '';
            const list = MODELS[provider] || MODELS['auto'];
            list.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m.id;
                opt.textContent = m.label;
                modelSelect.appendChild(opt);
            });
        }

        // initialize
        if (providerSelect) {
            populateModels(providerSelect.value || 'auto');
            providerSelect.addEventListener('change', (e) => populateModels(e.target.value));
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const headline = document.getElementById('headline').value;
            const description = document.getElementById('description').value;
            const language = document.getElementById('language').value;

            if (!headline.trim()) {
                showStatus('Please enter a headline', 'error');
                return;
            }
            
            if (!description.trim()) {
                showStatus('Please enter a description', 'error');
                return;
            }

            submitBtn.disabled = true;
            showStatus('<span class="spinner"></span> Generating video... This may take 1-2 minutes', 'loading');

            try {
                const formData = new FormData();
                formData.append('headline', headline);
                formData.append('description', description);
                formData.append('language', language);
                // include voice & model choices
                formData.append('female_voice', document.getElementById('voice_gender').value);
                formData.append('voice_provider', document.getElementById('voice_provider').value);
                formData.append('voice_model', document.getElementById('voice_model').value);
                formData.append('video_length', document.getElementById('video_length').value);

                const response = await fetch('/generate', {
                    method: 'POST',
                    body: formData
                });

                let data = null;
                const contentType = response.headers.get('content-type') || '';
                if (contentType.includes('application/json')) {
                    try {
                        data = await response.json();
                    } catch (e) {
                        data = { error: 'Invalid JSON response from server' };
                    }
                } else {
                    const text = await response.text();
                    try {
                        data = JSON.parse(text || '{}');
                    } catch (e) {
                        data = { error: text || 'Empty response from server' };
                    }
                }

                if (response.ok) {
                    showStatus('‚úì Video generated successfully!', 'success');
                    form.reset();
                    setTimeout(() => {
                        statusDiv.classList.remove('show');
                    }, 3000);
                    loadVideos();
                } else {
                    showStatus('‚úó ' + (data.error || 'Failed to generate video'), 'error');
                }
            } catch (error) {
                showStatus('‚úó Error: ' + error.message, 'error');
            } finally {
                submitBtn.disabled = false;
            }
        });

        function createShort() {
            document.getElementById('video_length').value = 'short';
            submitBtn.click();
        }

        function createLong() {
            document.getElementById('video_length').value = 'long';
            submitBtn.click();
        }

        function promptPost(provider) {
            const filename = prompt('Enter video filename (e.g. video_2026...mp4) to post:');
            if (!filename) return;
            let endpoint = '/' + provider + '/post';
            const form = new FormData();
            form.append('filename', filename);
            if (provider === 'wordpress') {
                const headline = prompt('Enter headline (optional):');
                if (headline) form.append('headline', headline);
            } else if (provider === 'facebook' || provider === 'instagram') {
                const caption = prompt('Enter caption (optional):');
                if (caption) form.append('caption', caption);
            } else if (provider === 'youtube') {
                const title = prompt('Enter title (optional):');
                const description = prompt('Enter description (optional):');
                if (title) form.append('title', title);
                if (description) form.append('description', description);
            }

            fetch(endpoint, { method: 'POST', body: form })
                .then(r => r.json())
                .then(d => alert(JSON.stringify(d)))
                .catch(e => alert('Error: ' + e.message));
        }

        function showStatus(message, type) {
            statusDiv.innerHTML = message;
            statusDiv.className = `status show ${type}`;
        }

        async function loadVideos() {
            try {
                const response = await fetch('/videos');
                let data = null;
                const contentType = response.headers.get('content-type') || '';
                if (contentType.includes('application/json')) {
                    try {
                        data = await response.json();
                    } catch (e) {
                        console.error('Failed to parse /videos JSON:', e);
                        data = { videos: [] };
                    }
                } else {
                    const text = await response.text();
                    try {
                        data = JSON.parse(text || '{}');
                    } catch (e) {
                        console.error('Unexpected /videos response:', text);
                        data = { videos: [] };
                    }
                }

                if (data.videos.length === 0) {
                    videosList.innerHTML = '<div class="empty-message">No videos generated yet</div>';
                    return;
                }

                videosList.innerHTML = data.videos.map(video => `
                    <div class="video-card">
                        <div class="video-title">${escapeHtml(video.headline)}</div>
                        <div class="video-meta">
                            <div class="video-meta-item">
                                <strong>Created:</strong> ${new Date(video.created_at).toLocaleString()}
                            </div>
                            <div class="video-meta-item">
                                <strong>Size:</strong> ${video.size_mb} MB
                            </div>
                        </div>
                        <div>
                            <span class="language-badge">${video.language.toUpperCase()}</span>
                            <span class="size-badge">${video.size_mb} MB</span>
                        </div>
                        <div class="video-actions">
                            <button class="download-btn" onclick="downloadVideo('${video.filename}', '${escapeHtml(video.headline)}')">‚¨á Download</button>
                            <button class="delete-btn" onclick="deleteVideo('${video.filename}')">üóë Delete</button>
                            <button class="share-fb" onclick="shareFacebook('${video.filename}', '${escapeHtml(video.headline)}')">f Share</button>
                            <button class="share-ig" onclick="shareInstagram('${video.filename}', '${escapeHtml(video.headline)}')">üì∏ IG</button>
                            <button class="share-wp" onclick="shareWordpress('${video.filename}', '${escapeHtml(video.headline)}')">W Publish</button>
                        </div>
                        <div class="post-info" id="post-info-${video.filename}"></div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading videos:', error);
            }
        }

        function downloadVideo(filename, headline) {
            const a = document.createElement('a');
            a.href = `/video/${filename}`;
            a.download = `${headline.substring(0, 30)}_${filename}`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        async function deleteVideo(filename) {
            if (!confirm('Are you sure you want to delete this video?')) {
                return;
            }

            try {
                const response = await fetch(`/video/${filename}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    loadVideos();
                } else {
                    alert('Failed to delete video');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Social sharing helpers
        function shareFacebook(filename, headline) {
            const videoUrl = window.location.origin + `/video/${filename}`;
            const shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(videoUrl)}`;
            window.open(shareUrl, '_blank', 'noopener');
        }

        async function shareInstagram(filename, headline) {
            const videoUrl = window.location.origin + `/video/${filename}`;

            // Try Web Share API first (mobile browsers)
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: headline,
                        text: headline,
                        url: videoUrl
                    });
                    return;
                } catch (e) {
                    console.warn('Web Share failed:', e);
                }
            }

            // Fallback: prompt user to download and upload to Instagram
            const msg = `Instagram requires native upload.\n\nOpen this link to download the video:\n${videoUrl}\n\nOr copy the link to clipboard.`;
            if (confirm(msg + '\n\nPress OK to copy link to clipboard.')) {
                try {
                    await navigator.clipboard.writeText(videoUrl);
                    alert('Link copied to clipboard. Download the video and post to Instagram.');
                } catch (e) {
                    prompt('Copy this link to clipboard:', videoUrl);
                }
            }
        }

        async function shareWordpress(filename, headline) {
            // Sends a request to backend to create a WordPress post from the generated video
            const postInfoId = `post-info-${filename}`;
            const postInfo = document.getElementById(postInfoId);
            const maxAttempts = 3;

            async function attemptPublish(attempt = 1) {
                // local UI feedback
                postInfo.innerHTML = `<div class="status loading show"><span class="spinner"></span> Publishing to WordPress... (attempt ${attempt}/${maxAttempts})</div>`;

                try {
                    const formData = new FormData();
                    formData.append('filename', filename);
                    formData.append('headline', headline);

                    const res = await fetch('/post-to-wordpress', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await res.json().catch(() => ({}));

                    if (res.ok && data.post) {
                        const postLink = data.post.link || data.post.guid?.rendered || data.post.url || '';
                        let html = `<div class="status success show">‚úì Published to WordPress</div>`;
                        if (postLink) {
                            html += `<div style="margin-top:8px">Post: <a href="${postLink}" target="_blank" rel="noopener">${postLink}</a></div>`;
                            html += `<div class="post-actions">`;
                            html += `<button onclick="window.open('${postLink}','_blank')">Open</button>`;
                            html += `<button onclick="embedPost('${postInfoId}','${postLink}')">Embed</button>`;
                            html += `</div>`;
                        } else {
                            html += `<div style="margin-top:8px">Post created (ID: ${data.post.id || 'unknown'})</div>`;
                        }

                        postInfo.innerHTML = html;
                        setTimeout(() => { if (postInfo) postInfo.querySelector('.status')?.classList.remove('show'); }, 3000);
                    } else {
                        const err = data.error || res.statusText || 'Unknown error';
                        if (attempt < maxAttempts) {
                            postInfo.innerHTML = `<div class="status error show">‚úó WordPress publish failed: ${err} ‚Äî retrying...</div>`;
                            await new Promise(r => setTimeout(r, 1200));
                            return attemptPublish(attempt + 1);
                        } else {
                            postInfo.innerHTML = `<div class="status error show">‚úó WordPress publish failed: ${err}</div><div class="post-actions"><button onclick="shareWordpress('${filename}','${headline}')">Retry</button></div>`;
                        }
                    }
                } catch (e) {
                    if (attempt < maxAttempts) {
                        postInfo.innerHTML = `<div class="status error show">‚úó Error: ${e.message} ‚Äî retrying...</div>`;
                        await new Promise(r => setTimeout(r, 1200));
                        return attemptPublish(attempt + 1);
                    }
                    postInfo.innerHTML = `<div class="status error show">‚úó Error: ${e.message}</div><div class="post-actions"><button onclick="shareWordpress('${filename}','${headline}')">Retry</button></div>`;
                }
            }

            attemptPublish();
        }

        function embedPost(containerId, url) {
            const container = document.getElementById(containerId);
            if (!container) return;
            // Remove existing embed if any
            const existing = container.querySelector('iframe.embed-preview');
            if (existing) {
                existing.remove();
                return;
            }

            const iframe = document.createElement('iframe');
            iframe.className = 'embed-preview';
            iframe.src = url;
            iframe.style.width = '100%';
            iframe.style.height = '400px';
            iframe.style.border = '1px solid rgba(255,255,255,0.06)';
            container.appendChild(iframe);
        }
    </script>

</body>
</html>
